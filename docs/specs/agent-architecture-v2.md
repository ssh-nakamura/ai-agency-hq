# エージェントアーキテクチャ v2 設計書

> 作成日: 2026-02-15
> 承認: 株主承認済み
> 参考: multi-agent-shogun (https://github.com/yohey-w/multi-agent-shogun)

---

## 設計思想

### 基本方針
1. **技術に依存しない設計**: Agent Teams / Task tool / 手動起動のどれでも動く
2. **ファイルベース通信**: エージェント間の指示・報告はすべてファイル経由
3. **厳格な指揮系統**: CEO→部門長。飛ばし禁止
4. **能動的な組織**: 指示待ちではなく、自ら問題を検知し報告する
5. **フェーズ適応**: Phase 0とPhase 2では動き方が違う

### 参考にしたもの
- multi-agent-shogun: ファイルベース通信、forbidden actions、復帰設計
- Claude Code公式ドキュメント: サブエージェントのベストプラクティス
- 実企業の組織論: 内部統制、エスカレーション、品質管理

---

## 組織階層

```
株主（若様）
  └── CEO（リードエージェント）
        ├── analyst（経営企画部長 / CFO兼務）
        ├── product-manager（事業開発部長 → プロダクト/SaaS系）
        ├── writer（広報部長 → コンテンツ事業主導）
        ├── x-manager（マーケティング部長）
        ├── video-creator（動画制作担当 → 動画事業主導）
        ├── site-builder（Web制作担当）
        └── legal（法務部長）
```

### 指揮系統ルール
- 株主 → CEO: 指示・承認
- CEO → 各部門長: タスク指示・レビュー
- 部門長 → CEO: 成果物報告・エスカレーション
- 部門長 → 部門長: **禁止**（CEOを経由する）
- 部門長 → 株主: **禁止**（CEOを経由する）

---

## 通信プロトコル

### 指示の流れ（トップダウン）
```
CEO → docs/tasks/{agent-name}.md に指示を書く
    → エージェントを起動（Agent Teams or Task tool or 手動）
    → エージェントは指示ファイルを読んで作業開始
```

### 報告の流れ（ボトムアップ）
```
エージェント → 成果物を所定のパスに保存
            → docs/tasks/{agent-name}.md の status を updated に変更
            → CEO が結果を確認しレビュー
```

### ファイル構成
```
docs/tasks/
  ├── analyst.md          # analystへの現在の指示と状態
  ├── product-manager.md  # PMへの現在の指示と状態
  ├── writer.md           # writerへの現在の指示と状態
  ├── x-manager.md        # x-managerへの現在の指示と状態
  ├── site-builder.md     # site-builderへの現在の指示と状態
  └── legal.md            # legalへの現在の指示と状態
```

### 指示ファイルのフォーマット
```markdown
# [エージェント名] タスク指示

## 現在のタスク
- task_id: T-XXX
- 指示: （何をしてほしいか）
- 完了基準: （何をもって完了とするか）
- 期限: （あれば）
- 優先度: high / medium / low

## 成果物の保存先
- （ファイルパス）

## 参考資料
- （読むべきファイル）

## ステータス
- [ ] 未着手 / 進行中 / 完了 / レビュー待ち
```

---

## エスカレーションルール

| レベル | 状況 | 対応 |
|--------|------|------|
| L1 | 判断に迷うが作業は続行可能 | 成果物にメモとして残し、CEOレビュー時に報告 |
| L2 | 作業方針が不明で進められない | 作業を中断し、CEOに判断を求める |
| L3 | 法的・倫理的リスクを検知 | 即座にCEOに報告。CEOは株主に上げる |
| L4 | 予算超過・想定外のコスト発生 | CEOに報告。¥30,000以上は株主承認必須 |

---

## 品質管理

### 完了基準（Definition of Done）の標準
すべての成果物は以下を満たすこと：
1. 指示された要件をすべて満たしている
2. 出典・根拠が明記されている（数値を含む場合）
3. 誤字脱字がない
4. 所定のフォーマットに従っている
5. 保存先パスが正しい

### レビュープロセス
```
エージェント: 成果物作成 → セルフレビュー → 保存
    ↓
CEO: 確認 → 承認 or 差し戻し（理由明記）
    ↓
（必要に応じて）株主: 最終承認
```

### 差し戻し時
- CEOは差し戻し理由を明記する
- エージェントは修正して再提出する
- 2回差し戻しが発生したら、CEOが方針を見直す

---

## 財務管理

### 予算権限

| 金額 | 承認者 |
|------|--------|
| ¥5,000未満 | CEO判断 |
| ¥5,000〜¥30,000 | CEO判断（株主に事後報告） |
| ¥30,000以上 | 株主承認必須 |

### 記録
- `docs/finances.md`: 月次収支の記録
- `docs/state.json`: KPIとしてのコスト実績
- analyst（CFO兼務）が月次で更新

---

## 起動モード

### Mode A: Agent Teams（推奨）
```bash
# 環境変数を設定
export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1
claude
# → CLAUDE.mdからCEO人格をロード
# → 必要に応じてチームメイトを起動
```

### Mode B: Task tool（--agentバグ修正後）
```bash
claude
# → Task toolでサブエージェントを呼び出し
```

### Mode C: 手動起動（フォールバック）
```bash
claude --agent analyst  # 株主が個別に起動
# → エージェントは docs/tasks/analyst.md を読んで作業
```

いずれのモードでも、指示・報告のファイル構成は共通。

---

## フェーズ別の行動切替

### Phase 0（現在: 基盤構築）
- analyst: 市場調査、コスト見積もり、**実コスト記録開始**
- product-manager: MVP仕様策定
- writer: LP文面、初回ブログ記事
- x-manager: 待機（Step 2から）
- site-builder: LP制作
- legal: 待機（Step 2から）

### Phase 1（プロダクト開発 + コンテンツ運用）
- analyst: KPI追跡、月次P&L、競合監視
- product-manager: ベータテスト設計、フィードバック分析
- writer: 週次ブログ、有料コンテンツ
- x-manager: 週5投稿、エンゲージメント分析
- site-builder: サイト更新、機能追加
- legal: 利用規約、プライバシーポリシー

### Phase 2（収益化）
- 全員がKPIにコミット
- analyst: 単位経済性分析、価格最適化
- CFO機能の本格化

---

## セキュリティ・倫理

### forbidden actions（全エージェント共通）
1. 株主の個人情報を外部に出力しない
2. 競合他社を中傷する表現を使わない
3. 法的助言を断定的に行わない（legalエージェント含む）
4. ユーザーデータを仮のものでも本物のように扱わない
5. 破壊的なgit操作を行わない（force push, reset --hard等）

### AI倫理（ShieldMe固有）
- 誹謗中傷の判定基準は透明性を確保する
- 誤判定のリスクを常に明示する
- 表現の自由との緊張関係を認識する
- 判定結果は「参考情報」であり「法的判断」ではないことを明記する
